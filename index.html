<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>七夕限定卡池｜一发入魂</title>
  <style>
    :root{
      --bg: radial-gradient(60% 50% at 10% 0%, #FFD1DC 0%, transparent 45%),
            radial-gradient(50% 50% at 90% 0%, #B5EAEA 0%, transparent 50%),
            linear-gradient(180deg, #F9F7F7 0%, #E3F6F5 100%);
      --glass: rgba(255,255,255,.5);
      --border: rgba(150,150,150,.3);
      --primary: #FFBD87;
      --accent: #A3D8F4;
      --good: #7DCFB6;
      --bad: #FF9A8B;
      --text: #5A6270;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; color:var(--text); font-family: ui-rounded, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Helvetica Neue", Arial, "Noto Color Emoji", sans-serif;
      background: var(--bg);
      overflow-x:hidden;
      background-size: cover;
      background-attachment: fixed;
    }
    .wrap{
      max-width:1100px; margin:0 auto; padding:24px; padding-bottom:120px;
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
    }
    .title{display:flex; align-items:center; gap:14px}
    .logo{
      width:56px; height:56px; border-radius:16px; background: linear-gradient(135deg,#FFD1DC,#FF9A8B 60%,#FFBD87);
      position:relative; box-shadow:0 10px 30px rgba(255,180,180,.35);
    }
    .logo:before{
      content:"❤"; position:absolute; inset:0; display:grid; place-items:center; font-size:28px; filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));
    }
    h1{margin:0; font-size: clamp(20px, 3vw, 28px);}
    .badge{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--glass); backdrop-filter: blur(10px); font-size:13px}

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.4));
      border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: 0 15px 60px rgba(0,0,0,.1);
    }
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px}
    @media (max-width: 940px){ .grid{ grid-template-columns: 1fr; } }

    .controls{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:none; padding:12px 16px; border-radius:14px; cursor:pointer; color:#fff; font-weight:700; letter-spacing:.4px;
      background:linear-gradient(90deg,#FF9A8B,#FFBD87);
      box-shadow:0 8px 24px rgba(255,157,139,.35);
      transition:.25s transform, .25s filter, .25s box-shadow;
    }
    .btn:hover{ transform: translateY(-2px); filter:saturate(1.06); box-shadow:0 10px 36px rgba(255,157,139,.45)}
    .btn.secondary{ background:linear-gradient(90deg,#A3D8F4,#B5EAEA); box-shadow:0 8px 24px rgba(163,216,244,.35) }
    .btn.ghost{ background:var(--glass); color:var(--text); border:1px dashed var(--border); box-shadow:none; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

    .rollzone{ display:grid; grid-template-columns: repeat(2,1fr); gap:10px; margin-top:14px; overflow:auto; scrollbar-gutter:stable; height:630px }
    .card{ position:relative; height:100px; width:250px; border-radius:16px; border:1px solid var(--border); overflow:hidden; background:rgba(255,255,255,.6); display:grid; place-items:center; padding:10px }
    .card.big{ grid-column:1/-1; height:180px }
    .tag{ position:absolute; top:8px; left:8px; font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.7); border:1px solid var(--border) }
    .card.r { background: linear-gradient(135deg, rgba(181,234,234,.5), rgba(163,216,244,.5));
      border: 2px solid rgba(163,216,244,.8);}
    .card.sr { background: linear-gradient(135deg, rgba(163,216,244,.5), rgba(125,207,246,.5));
      border: 2px solid rgba(77,166,255,.8); animation: shine 2.4s linear infinite;}
    .card.ssr{ background: radial-gradient(180px 80px at 80% -10%, rgba(255,255,255,.7), transparent 60%), linear-gradient(135deg, rgba(255,189,135,.5), rgba(163,216,244,.5));
      animation: shine 2.4s linear infinite; border-color: rgba(255,189,135,.8); }
    @keyframes shine{ 0%{ filter:brightness(1) } 50%{ filter:brightness(1.18) } 100%{ filter:brightness(1) } }

    .resultText{ text-align:center; line-height:1.35; font-size: clamp(14px, 2.4vw, 18px) }
    .muted{ color: #5A6270AA; font-size:12px }

    .flex{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .between{ display:flex; align-items:center; justify-content:space-between }

    .history{ min-height:260px; max-height:380px; overflow:auto; padding-right:6px }
    .historyItem{ display:flex; align-items:center; gap:10px; padding:8px 6px; border-bottom:1px dashed var(--border) }
    .pill{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:rgba(255,255,255,.5) }

    .prob-table{ width:100%; border-collapse:collapse; font-size:13px; margin-top:8px }
    .prob-table th, .prob-table td{ padding:6px 8px; border-bottom:1px dashed var(--border) }
    .prob-table th{ text-align:left; color:var(--text); font-weight:700 }
    .prob-table .p{ text-align:right; color:#FF9A8B }

    .chartWrap{ height:220px; }
    canvas#chart{ width:100%; height:100%; background: rgba(255,255,255,.3); border-radius:14px; border:1px solid var(--border) }

    .notice{ font-size:13px; opacity:.9 }

    /* Barrage / 弹幕 */
    .barrage{ position: fixed; inset: 0 0 auto 0; pointer-events:none; z-index: 50; overflow:hidden }
    .bullet{ position:absolute; white-space:nowrap; left:100%; top:0; padding:4px 10px; border-radius:999px; background: rgba(255,255,255,.7); border:1px solid var(--border); font-size:13px; filter: drop-shadow(0 2px 4px rgba(0,0,0,.1));
      animation: fly linear forwards; }
    @keyframes fly{ to{ transform: translateX(calc(-100vw - 120%)); } }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; place-items:center; z-index:60 }
    .modal .inner{ width:min(720px, 92vw); background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.4)); border:1px solid var(--border); border-radius:18px; padding:16px }

    /* Confetti */
    .confetti{ position:fixed; inset:0; pointer-events:none; z-index:70 }
    .confetti span{ position:absolute; width:8px; height:14px; background:linear-gradient(180deg,#fff,#FFBD87); transform: rotate(0deg); opacity:.9; border-radius:2px }

    /* Footer */
    footer{ position:fixed; inset:auto 0 0 0; padding:8px 16px; display:flex; justify-content:center; }
    .footer{
      background:rgba(255,255,255,.6); border:1px solid var(--border); color:var(--text); font-size:12px; padding:6px 10px; border-radius:10px; backdrop-filter: blur(8px);
    }

    /* Scrollbar niceness */
    ::-webkit-scrollbar{ width:10px; height:10px }
    ::-webkit-scrollbar-thumb{ background: linear-gradient(180deg,#B5EAEA,#A3D8F4); border-radius:10px }
    ::-webkit-scrollbar-track{ background: transparent }
  </style>
</head>
<body>
  <div class="barrage" id="barrage"></div>
  <div class="confetti" id="confetti"></div>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="logo"></div>
        <div>
          <h1>🎉❤️ 七夕限定卡池 · 抽卡模拟 ❤️🎉</h1>
          <div class="muted">@群友 编辑发送"咱俩试试？"💌 即有机会获得限定 SSR「好呀宝宝」</div>
        </div>
      </div>
      <span class="badge">抽取日期：2025-08-29 之前</span>
    </header>

    <div class="grid" style="margin-top:16px">
      <section class="panel">
        <div class="between">
          <div class="flex">
            <button class="btn" id="roll1">单抽</button>
            <button class="btn secondary" id="roll10">十连</button>
            <button class="btn ghost" id="clear">清空记录</button>
          </div>
          <div class="pill" id="status">就绪 ✅</div>
        </div>

        <div class="rollzone" id="rollzone"></div>
      </section>

      <aside class="panel">
        <div class="between" style="margin-bottom:8px">
          <strong>出货统计</strong>
          <span class="muted" id="total">0 抽</span>
        </div>
        <div class="chartWrap">
          <canvas id="chart"></canvas>
        </div>

        <div class="between" style="margin-top:16px"><strong>历史记录</strong>
          <button class="btn ghost" id="export">导出</button>
        </div>
        <div class="history" id="history"></div>
      </aside>
    </div>

    <section class="panel" style="margin-top:16px">
      <details open>
        <summary style="cursor:pointer"><strong>概率公示</strong> <span class="muted">* Tip：SSR 超低概率，非酋请量力而抽。</span></summary>
        <table class="prob-table" id="probTable"><thead><tr><th>结果</th><th class="p">概率</th></tr></thead><tbody></tbody></table>
        <div class="notice">⚠️ 本页面仅用于娱乐，抽取结果随机，概率已在界面公开显示。你可以自定义奖池文本与概率，带来更合群的梗味体验。</div>
      </details>
    </section>

    <section class="panel" style="margin-top:16px">
      <details>
        <summary style="cursor:pointer"><strong>自定义配置</strong> <span class="muted">（可将下方 JSON 粘贴覆盖）</span></summary>
        <div class="muted" style="margin:8px 0">字段：<code>label</code> 文案，<code>weight</code> 概率占比（总和 = 100），<code>tag</code> 标签（可选：SSR/SR/R），<code>type</code> 触发特殊效果（可选：<code>ssr</code>、<code>image</code>、<code>quote</code>）。</div>
        <textarea id="configArea" style="width:100%; height:180px; background:rgba(255,255,255,.5); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace"></textarea>
        <div class="flex" style="margin-top:8px">
          <button class="btn" id="applyCfg">应用配置</button>
          <button class="btn ghost" id="resetCfg">还原默认</button>
        </div>
      </details>
    </section>
  </div>

  <!-- 结果放大 Modal -->
  <div class="modal" id="modal">
    <div class="inner">
      <div class="between" style="margin-bottom:8px">
        <strong>抽取结果</strong>
        <button class="btn ghost" id="closeModal">关闭</button>
      </div>
      <div class="card big" id="modalCard">
        <span class="tag" id="modalTag"></span>
        <div class="resultText" id="modalText"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== 配置======
    const DEFAULT_POOL = [
      { label: "滚你妈的", weight: 0, tag: "R" },
      { label: "去你妈的", weight: 0, tag: "R" },
      { label: "你也配？", weight: 0, tag: "R" },
      { label: "傻逼二次元", weight: 0, tag: "R" },
      { label: "癔症又犯了？", weight: 0, tag: "R" },
      { label: "死男同真恶心", weight: 0, tag: "SR" },
      { label: "现在是幻想时刻", weight: 0, tag: "SR" },
      { label: "柚子厨滚出去", weight: 0, tag: "SR" },
      { label: "这是最后通牒", weight: 0, tag: "SR" },
      { label: "以后不要再和我扯上关系", weight: 0, tag: "SR" },
      { label: "被拉黑+屏蔽", weight: 0, tag: "SR" },
      { label: "小男娘", weight: 0, tag: "SR" },
      { label: "发来一张可爱图片", weight: 0, tag: "SR", type:"image" },
      { label: "收到一段鸡汤文", weight: 0, tag: "SR", type:"quote" },
      { label: "下次再说吧", weight: 0, tag: "SR" },
      { label: "你是个好人", weight: 0, tag: "SR" },
      { label: "我一直把你当好朋友", weight: 0, tag: "SR" },
      { label: "滚出去", weight: 0, tag: "R" },
      { label: "好呀宝宝", weight: 100, tag: "SSR", type: "ssr" }
    ];


    const PLACEHOLDER_SVGS = [
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#FFBD87"/><stop offset="1" stop-color="#A3D8F4"/></linearGradient></defs><rect width="100%" height="100%" fill="#F9F7F7"/><circle cx="90" cy="60" r="38" fill="url(#g)"/><rect x="120" y="40" width="50" height="40" rx="8" fill="#fff" opacity=".15"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120"><rect width="100%" height="100%" fill="#F9F7F7"/><g opacity=".9"><path d="M10 100 Q100 20 190 100" fill="none" stroke="#B5EAEA" stroke-width="6"/></g><circle cx="150" cy="38" r="12" fill="#FFBD87"/></svg>',
      '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120"><rect width="100%" height="100%" fill="#F9F7F7"/><g><rect x="18" y="20" width="60" height="80" rx="10" fill="#A3D8F4" opacity=".5"/><rect x="88" y="28" width="60" height="64" rx="10" fill="#FFBD87" opacity=".6"/><rect x="158" y="36" width="24" height="48" rx="8" fill="#7DCFB6" opacity=".6"/></g></svg>'
    ];

const colors = ["#FFBD87", "#A3D8F4", "#7DCFB6", "#B5EAEA"];
const bgColor = "#F9F7F7";

for (let i = 0; i < 100; i++) {
  const shapeType = Math.floor(Math.random() * 3); // 0: circle, 1: rect, 2: ellipse
  const shapes = [];

  const shapeCount = 2 + Math.floor(Math.random() * 3); // 每个 SVG 2~4 个形状

  for (let j = 0; j < shapeCount; j++) {
    const x = 20 + Math.random() * 160;
    const y = 20 + Math.random() * 80;
    const w = 10 + Math.random() * 40;
    const h = 10 + Math.random() * 40;
    const r = 5 + Math.random() * 30;
    const fill = colors[Math.floor(Math.random() * colors.length)];
    const opacity = (0.5 + Math.random() * 0.4).toFixed(2);

    if (shapeType === 0) {
      shapes.push(`<circle cx="${x}" cy="${y}" r="${r}" fill="${fill}" opacity="${opacity}"/>`);
    } else if (shapeType === 1) {
      shapes.push(`<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${r/2}" fill="${fill}" opacity="${opacity}"/>`);
    } else {
      shapes.push(`<ellipse cx="${x}" cy="${y}" rx="${w/2}" ry="${h/2}" fill="${fill}" opacity="${opacity}"/>`);
    }
  }

  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120"><rect width="100%" height="100%" fill="${bgColor}"/><g>${shapes.join('')}</g></svg>`;
  PLACEHOLDER_SVGS.push(svg);
}

    const QUOTES = [
      "宇宙浪漫, 皆因你我。",
      "花会沿路盛开, 你以后的路也是。",
      "把月亮摘给你, 也把好运攒给你。",
      "愿所有的喜欢都不必解释。",
      "希望你每天醒来都有好心情。",
      "星光不问赶路人, 时光不负有心人。",
      "愿你心怀梦想, 脚踏实地。",
      "你笑起来的样子, 是这个世界最美的风景。",
      "生活虽忙, 也别忘了善待自己。",
      "愿所有的努力都不被辜负。",
      "每一次坚持, 都是自我成长的证明。",
      "在平凡的日子里, 也能发现小小的惊喜。",
      "愿你被温柔以待, 被喜欢的人环绕。",
      "不要忘记仰望星空, 感受无限可能。",
      "每一个今天, 都值得被好好记住。",
      "愿你的每一步都走得坚定而温暖。",
      "不必急于奔跑, 慢慢来也会到达终点。",
      "愿你拥有发现美好的眼睛和心情。",
      "岁月静好, 你我安然。",
      "保持善良, 保持热爱, 保持好奇心。"
    ];


    // ====== 状态与 DOM ======
    let POOL = JSON.parse(JSON.stringify(DEFAULT_POOL));
    const roll1Btn = document.getElementById('roll1');
    const roll10Btn = document.getElementById('roll10');
    const clearBtn = document.getElementById('clear');
    const exportBtn = document.getElementById('export');
    const statusEl = document.getElementById('status');
    const rollzone = document.getElementById('rollzone');
    const historyEl = document.getElementById('history');
    const totalEl = document.getElementById('total');
    const probTableBody = document.querySelector('#probTable tbody');
    const configArea = document.getElementById('configArea');

    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const modalCard = document.getElementById('modalCard');
    const modalText = document.getElementById('modalText');
    const modalTag = document.getElementById('modalTag');

    let HISTORY = []; // {ts, label, tag}
    const COUNTS = new Map();

    // 截止时间（本地时区）
    const DEADLINE = new Date('2025-08-29T00:00:00');

    function checkDeadline(){
      const now = new Date();
      const expired = now >= DEADLINE;
      roll1Btn.disabled = expired;
      roll10Btn.disabled = expired;
      statusEl.textContent = expired ? '活动已结束 ⛔' : '就绪 ✅';
    }

    // 初始化概率表 & 配置区
    function renderProbTable(){
      probTableBody.innerHTML = '';
      let sum = 0;
      POOL.forEach(item=> sum += Number(item.weight));
      POOL.forEach(item=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHTML(item.label)} <span class="pill" style="margin-left:6px">${item.tag||'R'}</span></td><td class="p">${Number(item.weight)}%</td>`;
        probTableBody.appendChild(tr);
      });
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><em>总计</em></td><td class="p"><em>${sum.toFixed(2)}%</em></td>`;
      probTableBody.appendChild(tr);
    }

    function resetCounts(){
      COUNTS.clear();
      POOL.forEach(i=> COUNTS.set(i.label, 0));
    }

    function updateStats(){
      totalEl.textContent = `${HISTORY.length} 抽`;
      drawChart();
    }

    // 加权随机
    function weightedPick(){
      const r = Math.random()*100; // 0 ~ 100
      let acc = 0;
      for(const item of POOL){
        acc += Number(item.weight);
        if(r <= acc) return item;
      }
      return POOL[POOL.length-1];
    }

    // 渲染单张卡片
    function renderCard(result){
      const card = document.createElement('div');
      card.className = 'card ' + result.tag.toLowerCase();
      const tag = document.createElement('span'); tag.className='tag'; tag.textContent = result.tag||'R';
      const text = document.createElement('div'); text.className='resultText';

      // 特殊类型展示
      if(result.type === 'image'){
        const img = document.createElement('img');
        img.alt = result.label; img.style.maxWidth='100%'; img.style.maxHeight='100%'; img.style.borderRadius='10px';
        img.src = 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(PLACEHOLDER_SVGS[Math.floor(Math.random()*PLACEHOLDER_SVGS.length)]);
        text.appendChild(img);
        const small = document.createElement('div'); small.textContent = result.label; small.className='muted'; small.style.marginTop='6px'; text.appendChild(small);
      } else if(result.type === 'quote'){
        text.innerHTML = `<div style="font-size:18px; opacity:.95">“${escapeHTML(QUOTES[Math.floor(Math.random()*QUOTES.length)])}”</div><div class="muted" style="margin-top:6px">${escapeHTML(result.label)}</div>`;
      } else {
        text.textContent = result.label;
      }

      card.appendChild(tag);
      card.appendChild(text);

      // 点击放大
      card.addEventListener('click', ()=> openModalFor(result));
      return card;
    }

    function openModalFor(result){
      modal.style.display='grid';
      modalCard.className = 'card big' + (result.tag==='SSR' ? ' ssr' : '');
      modalText.innerHTML = '';
      modalTag.textContent = result.tag || 'R';
      if(result.type === 'image'){
        const img = document.createElement('img');
        img.alt = result.label; img.style.maxWidth='100%'; img.style.maxHeight='100%'; img.style.borderRadius='10px';
        img.src = 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(PLACEHOLDER_SVGS[Math.floor(Math.random()*PLACEHOLDER_SVGS.length)]);
        modalText.appendChild(img);
        const small = document.createElement('div'); small.textContent = result.label; small.className='muted'; small.style.marginTop='6px'; modalText.appendChild(small);
      } else if(result.type === 'quote'){
        modalText.innerHTML = `<div style="font-size:22px; opacity:.95">“${escapeHTML(QUOTES[Math.floor(Math.random()*QUOTES.length)])}”</div><div class="muted" style="margin-top:6px">${escapeHTML(result.label)}</div>`;
      } else {
        modalText.textContent = result.label;
      }
    }

    closeModal.addEventListener('click', ()=> modal.style.display='none');
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });

    // 弹幕
    const barrage = document.getElementById('barrage');
    function shootBullet(text){
      const span = document.createElement('span');
      span.className = 'bullet';
      span.textContent = `已抽出：${text}`;
      const vh = Math.max(window.innerHeight*0.8, 300);
      span.style.top = Math.round(Math.random() * (vh-40)) + 'px';
      const dur = 8 + Math.random()*6; // 8~14s
      span.style.animationDuration = dur+'s';
      barrage.appendChild(span);
      setTimeout(()=> span.remove(), dur*1000 + 200);
    }

    // 简易烟花彩带（SSR）
    const confetti = document.getElementById('confetti');
    function boomConfetti(){
      for(let i=0;i<180;i++){
        const s = document.createElement('span');
        s.style.left = Math.random()*100 + 'vw';
        s.style.top = '-10px';
        const rot = Math.random()*360;
        const dur = 1500 + Math.random()*1200;
        s.animate([
          { transform:`translateY(0) rotate(${rot}deg)` , opacity:1 },
          { transform:`translateY(100vh) rotate(${rot+360}deg)`, opacity:0.8 }
        ], { duration: dur, easing: 'cubic-bezier(.12,.78,.22,1)', fill:'forwards' });
        confetti.appendChild(s);
        setTimeout(()=> s.remove(), dur+100);
      }
    }

    // 历史记录
    function pushHistory(item){
      HISTORY.push({ ts: Date.now(), label:item.label, tag:item.tag||'R' });
      COUNTS.set(item.label, (COUNTS.get(item.label)||0) + 1);
      const h = document.createElement('div'); h.className = 'historyItem';
      h.innerHTML = `<span class="pill">${item.tag||'R'}</span><span>${escapeHTML(item.label)}</span><span class="muted" style="margin-left:auto">${new Date().toLocaleTimeString()}</span>`;
      historyEl.prepend(h);
    }

    // 绘制统计条形图
    const chart = document.getElementById('chart');
    const ctx = chart.getContext('2d');
    function drawChart(){
      const dpr = window.devicePixelRatio || 1;
      const { width, height } = chart.getBoundingClientRect();
      chart.width = width * dpr; chart.height = height * dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,width,height);
      const labels = POOL.map(i=> i.tag==='SSR'? 'SSR':'');
      const counts = POOL.map(i=> COUNTS.get(i.label)||0);
      const max = Math.max(1, ...counts);
      const barW = Math.max(6, (width - 40)/counts.length - 6);
      ctx.fillStyle = 'rgba(255,255,255,.3)'; ctx.fillRect(0,0,width,height);
      ctx.fillStyle = '#5A6270AA'; ctx.fillText('次数', 8, 14);
      counts.forEach((v,i)=>{
        const x = 20 + i*(barW+6);
        const h = Math.round((v/max) * (height-40));
        ctx.fillStyle = POOL[i].tag==='SSR' ? '#FFBD87' : (POOL[i].tag==='SR' ? '#A3D8F4' : '#B5EAEA');
        ctx.fillRect(x, height-20-h, barW, h);
      });
    }

    // 工具
    function escapeHTML(s){ return (s+"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    // 抽卡流程
    function doRoll(times){
      roll1Btn.disabled = true;
      roll10Btn.disabled = true;
      const zone = rollzone; zone.innerHTML = '';
      for(let i=0;i<times;i++){
        // 动画延时：十连顺次翻牌
        setTimeout(()=>{
          const item = weightedPick();
          const card = renderCard(item);
          zone.appendChild(card);
          // 小翻转动画
          card.animate([{ transform:'rotateY(88deg) scale(.9)', opacity:.2 }, { transform:'rotateY(0) scale(1)', opacity:1 }], { duration: 1200, easing: 'cubic-bezier(.2,.9,.2,1)' });

          pushHistory(item);
          shootBullet(`${item.tag||'R'} · ${item.label}`);
          updateStats();

          if(item.type === 'ssr'){
            boomConfetti();
            statusEl.textContent = '🎉 恭喜抽中 SSR！';
          }
          if(i == times-1){
            roll1Btn.disabled = false;
            roll10Btn.disabled = false;

          }
        }, i*260);
      }
    }

    // 导出
    function exportJSON(){
      const data = { history: HISTORY, counts: Object.fromEntries(COUNTS), pool: POOL };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'gacha_export.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // 配置应用
    function applyConfig(json){
      try{
        const arr = JSON.parse(json);
        const sum = arr.reduce((s,i)=> s + Number(i.weight||0), 0);
        if(Math.abs(sum - 100) > 1e-6) throw new Error('概率总和需为 100，目前为 '+sum);
        if(!arr.length) throw new Error('配置为空');
        POOL = arr; resetCounts(); HISTORY = []; historyEl.innerHTML=''; updateStats(); renderProbTable();
        statusEl.textContent = '已应用新配置 ✅';
      }catch(err){
        alert('配置错误：'+ err.message);
      }
    }

    // 绑定
    roll1Btn.addEventListener('click', ()=> doRoll(1));
    roll10Btn.addEventListener('click', ()=> doRoll(10));
    clearBtn.addEventListener('click', ()=>{ HISTORY=[]; historyEl.innerHTML=''; resetCounts(); updateStats(); statusEl.textContent='已清空 🧹'; rollzone.innerHTML=''; });
    exportBtn.addEventListener('click', exportJSON);

    document.getElementById('applyCfg').addEventListener('click', ()=> applyConfig(configArea.value));
    document.getElementById('resetCfg').addEventListener('click', ()=>{ configArea.value = JSON.stringify(DEFAULT_POOL,null,2); applyConfig(configArea.value); });

    // 首次渲染
    checkDeadline();
    renderProbTable();
    resetCounts();
    updateStats();
    configArea.value = JSON.stringify(DEFAULT_POOL,null,2);

    // 每分钟检查一次截止
    setInterval(checkDeadline, 60000);



function rollAutoClick() {
    if (roll10Btn && !roll10Btn.disabled && getComputedStyle(roll10Btn).pointerEvents !== 'none') {
        console.log('按钮可用，点击一次');
        roll10Btn.click();
    }
};

// 自动化
// setInterval(rollAutoClick, 100);
// 如果需要停止轮询，可以调用
// clearInterval(rollInterval);

  </script>
</body>
</html>
